<%@ page contentType="text/html; charset=UTF-8"%>

    <style>

        .card-container {
            position: absolute;
            padding: 5px;
            background-color: rgba(29, 16, 45, 0.35);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255,255,255,0.4);
            cursor: grab;
        }

        .new-list-card {
            width: 500px;
            height: 500px;
            padding: 20px;
            border-radius: 16px;
            background-color: rgba(29, 16, 45, 0.3);
            position: relative;
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .top-dots {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
            color: white;
            cursor: grab;
            user-select: none;
        }

        .title-input {
            width: 80%;
            margin-top: 50px;
            padding: 10px;
            font-size: 18px;
            border: none;
            border-bottom: 1px solid white;
            background: transparent;
            color: white;
            text-align: center;
        }
        
        .title-label {
		    font-size: 20px;
		    font-weight: bold;
		    margin-top: 30px;
		    color: white;
		}

        .list-container {
            margin-top: 20px;
            width: 80%;
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .list-container::-webkit-scrollbar {
			    display: none;            
			}

		.list-item {
		    padding: 10px 0;
		    width: 100%;
		    border-bottom: 2px solid white;  
		    color: white;
		    font-size: 18px;
		    text-align: center;
		    background: transparent;         
		    border-radius: 0;                
        
		}

        .custom-button {
            position: absolute;
            width: 80%;
            padding: 12px;
            font-size: 16px;
            border-radius: 10px;
            background-color: #1c0035;
            color: white;
            border: 1px solid white;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .add-btn {
            top: 400px;
            width: 350px;
            border: 2px solid white;
            font-family: 'PFStarDust', sans-serif !important;
        }

        .view-btn {
            top: 460px;
            width: 350px;
            border: 2px solid white;
            font-family: 'PFStarDust', sans-serif !important;
        }

        .custom-button:hover {
            background-color: #33005a;
        }
    </style>

   		<div class="card-container">
        <div class="new-list-card">
            <div class="top-dots">:::</div>
            <div class="title-label">ÏÉàÎ°úÏö¥ Î™©Î°ù</div>
            <div class="list-container" id="listContainer"></div>
            <button class="custom-button add-btn">Ôºã Î¶¨Ïä§Ìä∏ Ï∂îÍ∞ÄÌïòÍ∏∞</button>
            <button class="custom-button view-btn">Î™©Î°ù ÌôïÏù∏</button>
        </div>
    </div>

    <script>
    function reloadCategoryButtons() {
        const listContainer = document.getElementById('listButtonContainer');
        listContainer.innerHTML = ""; // Í∏∞Ï°¥ Î≤ÑÌäºÎì§ Ï†úÍ±∞

        fetch("getObjGroupList.jsp")
            .then(res => res.json())
            .then(data => {
                data.forEach(group => {
                    const btn = document.createElement('button');
                    btn.className = 'obj-edit-btn';
                    btn.textContent = group.objgroup_name;

                    btn.addEventListener('click', () => {
                        localStorage.setItem("currentList", group.objgroup_id);
                        localStorage.setItem("currentListName", group.objgroup_name);
                        renderTasksForCurrentList(); // Í≥ºÏ†ú Î™©Î°ù Í∞±Ïã†
                    });

                    listContainer.appendChild(btn);
                });

                // Ìé∏Ïßë Î≤ÑÌäºÎèÑ Îã§Ïãú Ï∂îÍ∞Ä
                const editBtn = document.createElement('button');
                editBtn.className = 'obj-edit-btn';
                editBtn.textContent = '‚úé';
                editBtn.addEventListener('click', () => {
                    const rect = document.getElementById('cardWrapper').getBoundingClientRect();
                    localStorage.setItem("cardLeft", Math.floor(rect.left));
                    localStorage.setItem("cardTop", Math.floor(rect.top));
                    document.getElementById("cardWrapper").style.display = "none";
                    document.getElementById("listCardWrapper").style.display = "block";
                });
                listContainer.appendChild(editBtn);
            });
    }
    
        // ÎìúÎûòÍ∑∏ Í∏∞Îä•
        const dragHandle = document.querySelector('.top-dots');
        const card = document.querySelector('.card-container');

        window.isDraggingList = false;
        window.offsetXList = 0;
        window.offsetYList = 0;

        dragHandle.addEventListener('mousedown', function (e) {
            window.isDraggingList = true;
            window.offsetXList = e.clientX - card.offsetLeft;
            window.offsetYList = e.clientY - card.offsetTop;
        });

        document.addEventListener('mousemove', function (e) {
            if (window.isDraggingList) {
                card.style.left = (e.clientX - window.offsetXList) + 'px';
                card.style.top = (e.clientY - window.offsetYList) + 'px';
            }
        });

        document.addEventListener('mouseup', function () {
            window.isDraggingList = false;
        });

        // Î¶¨Ïä§Ìä∏ Ï∂îÍ∞Ä Í∏∞Îä•
        const addBtnList = document.querySelector('.add-btn');
        const listContainer = document.getElementById('listContainer');

        let count = 1;
        addBtnList.addEventListener('click', function () {
            const newItem = document.createElement('div');
            newItem.className = 'list-item';

            const input = document.createElement('input');
            input.type = 'text';
            input.value = `ÏòàÏ†ú ${count}`;
            input.style = '...';

            const deleteBtn = document.createElement('span');
            deleteBtn.textContent = '‚úï';
            deleteBtn.style = '...';
            
            input.style.border = 'none';
            input.style.background = 'transparent';
            input.style.color = 'white';
            input.style.fontSize = '18px';
            input.style.textAlign = 'center';
            input.style.width = '90%';
            input.style.outline = 'none';
            // Ïö∞ÏÑ† DOMÏóê Ï∂îÍ∞Ä
            newItem.appendChild(input);
            newItem.appendChild(deleteBtn);
            listContainer.appendChild(newItem);
            input.focus();
            count++;

            // DBÏóê Ï†ÄÏû•ÌïòÍ≥† id Î∞õÏïÑÏò§Í∏∞
            fetch("insertObjGroup.jsp", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "objgroup_name=" + encodeURIComponent(input.value)
            })
            .then(res => res.text())
            .then(id => {
            	id = id.trim();
                console.log("üÜî ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú objgroup_id:", id);

                // üéØ Ïó¨Í∏∞Ïóê ÎîîÎ∞îÏö¥Ïä§ + ÏàòÏ†ï ÏóÖÎç∞Ïù¥Ìä∏ Ïó∞Í≤∞
                const debounce = (func, delay) => {
                    let timer;
                    return function (...args) {
                        clearTimeout(timer);
                        timer = setTimeout(() => func.apply(this, args), delay);
                    };
                };

                const updateCategoryName = debounce(() => {
                    fetch("updateObjGroup.jsp", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: "objgroup_id=" + id + "&objgroup_name=" + encodeURIComponent(input.value)
                    })
                    .then(res => res.text())
                    .then(msg => console.log("üìù ÏàòÏ†ï ÏùëÎãµ:", msg))
                    .catch(err => console.error("‚ùå ÏàòÏ†ï Ïã§Ìå®:", err));
                }, 800);

                input.addEventListener("input", updateCategoryName);
            })
            .catch(err => {
                console.error("‚ùå insert Ïã§Ìå®:", err);
            });
        });

        //ÏúÑÏπò Î≥µÏõê
       window.addEventListener("DOMContentLoaded", function () {
    const card = document.querySelector('.card-container');
    const left = localStorage.getItem("cardLeft") || "100";
    const top = localStorage.getItem("cardTop") || "100";

    card.style.left = left + "px";
    card.style.top = top + "px";

    const listContainer = document.getElementById("listContainer");

    // üî• DBÏóêÏÑú Î¶¨Ïä§Ìä∏ Î∂àÎü¨Ïò§Í∏∞
    fetch("getObjGroupList.jsp")
        .then(response => response.json())
        .then(data => {
            data.forEach(group => {
                const item = document.createElement("div");
                item.className = "list-item";

                const input = document.createElement("input");
                input.type = "text";
                input.value = group.objgroup_name;
                /* input.readOnly = false; */
                input.style.border = 'none';
                input.style.background = 'transparent';
                input.style.color = 'white';
                input.style.fontSize = '18px';
                input.style.textAlign = 'center';
                input.style.width = '90%';
                input.style.outline = 'none';
                
             // ÎîîÎ∞îÏö¥Ïä§ Ìï®Ïàò Ï†ïÏùò (Í≥µÌÜµ)
                function debounce(func, delay) {
                    let timer;
                    return function (...args) {
                        clearTimeout(timer);
                        timer = setTimeout(() => func.apply(this, args), delay);
                    };
                }

                //  ÏàòÏ†ï ÎÇ¥Ïö©ÏùÑ ÏÑúÎ≤ÑÏóê Î∞òÏòÅ
                const updateCategoryName = debounce(() => {
                    fetch("updateObjGroup.jsp", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: "objgroup_id=" + group.objgroup_id + "&objgroup_name=" + encodeURIComponent(input.value)
                    })
                    .then(res => res.text())
                    .then(msg => console.log("üìù ÏàòÏ†ï ÏùëÎãµ:", msg))
                    .catch(err => console.error("‚ùå ÏàòÏ†ï Ïã§Ìå®:", err));
                }, 800); // 800ms ÌõÑÏóê ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠

                //  input Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
                input.addEventListener("input", updateCategoryName);

                const deleteBtn = document.createElement("span");
                deleteBtn.textContent = "‚úï";
                deleteBtn.style = 'float: right; margin-right: 10px; cursor: pointer; color: white; font-weight: bold;';
                deleteBtn.addEventListener("click", function () {
                    const confirmed = confirm(`"${input.value}" Ìï≠Î™©ÏùÑ Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`);
                    if (confirmed) {
                        listContainer.removeChild(item);

                        //  DBÏóêÏÑú ÏÇ≠Ï†ú ÏöîÏ≤≠ÎèÑ Í∞ÄÎä•!
                        fetch("deleteObjGroup.jsp", {
                             method: "POST",
                             headers: {
                                 "Content-Type": "application/x-www-form-urlencoded"
                             },
                             body: "objgroup_id=" + group.objgroup_id
                         });
                    }
                });

                item.appendChild(input);
                item.appendChild(deleteBtn);
                listContainer.appendChild(item);
            });
        })
        .catch(err => {
            console.error("‚ùå Î¶¨Ïä§Ìä∏ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", err);
        });
	});

        //Objective.jspÎ°ú Ïù¥Îèô
        const viewBtn = document.querySelector('.view-btn');
        const cardContainer = document.querySelector('.card-container');

        viewBtn.addEventListener('click', function () {
        	const rect = cardContainer.getBoundingClientRect();
        	const left = Math.floor(rect.left + window.scrollX);
        	const top = Math.floor(rect.top + window.scrollY);

        	localStorage.setItem("cardLeft", left);
        	localStorage.setItem("cardTop", top);

        	const existingLists = JSON.parse(localStorage.getItem("userLists") || "[]");
        	const listItems = document.querySelectorAll(".list-item input[type='text']");
        	const newListNames = Array.from(listItems)
        		.map(input => input.value.trim())
        		.filter(name => name.length > 0);

        	const mergedLists = [...new Set([...existingLists, ...newListNames])];
        	localStorage.setItem("userLists", JSON.stringify(mergedLists));

        	// ‚úÖ ÌôîÎ©¥ Ï†ÑÌôò: Î¶¨Ïä§Ìä∏ ‚Üí ÏûëÏóÖÎ™©Ìëú
        	document.getElementById("listCardWrapper").style.display = "none";
        	document.getElementById("objWrapper").style.display = "block";

        	// ‚úÖ ÎÇ¥Î∂Ä Ïπ¥ÎìúÎèÑ Í∞ïÏ†ú ÌëúÏãú
        	const cardWrapper = document.getElementById("cardWrapper");
        	if (cardWrapper) {
        		cardWrapper.style.display = "block";
        		cardWrapper.style.left = (localStorage.getItem("cardLeft") || "100") + "px";
        		cardWrapper.style.top = (localStorage.getItem("cardTop") || "100") + "px";
        	}

        	// ‚úÖ Í≥ºÏ†ú Îã§Ïãú Î†åÎçîÎßÅ
        	if (typeof renderTasksForCurrentList === 'function') {
        		renderTasksForCurrentList();
        	}
        	
        	reloadCategoryButtons();  // ‚ú® ÏµúÏã† Î¶¨Ïä§Ìä∏ Î∂àÎü¨Ïò§Í∏∞
            renderTasksForCurrentList(); // ÏÑ†ÌÉùÎêú Î¶¨Ïä§Ìä∏ Í∏∞Ï§ÄÏúºÎ°ú Í≥ºÏ†ú Î≥¥Ïó¨Ï£ºÍ∏∞
        });



    </script>